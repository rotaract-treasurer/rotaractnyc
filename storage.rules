rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return request.auth.token.role;
    }
    
    function isMember() {
      return isAuthenticated() && getUserRole() in ['MEMBER', 'BOARD', 'TREASURER', 'ADMIN'];
    }
    
    function isBoard() {
      return isAuthenticated() && getUserRole() in ['BOARD', 'TREASURER', 'ADMIN'];
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }
    
    // Community posts - members can read all, write their own
    match /community-posts/{userId}/{fileName} {
      allow read: if isMember();
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }
    
    // Documents - members can read, board can write
    match /documents/{fileName} {
      allow read: if isMember();
      allow write, delete: if isBoard();
    }
    
    // Profile photos - members can read all, write their own
    match /profile-photos/{userId}/{fileName} {
      allow read: if isMember();
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }
    
    // Event images - members can read, board can write
    match /event-images/{eventId}/{fileName} {
      allow read: if isMember();
      allow write, delete: if isBoard();
    }
    
    // Gallery images - public read for public galleries, members for member galleries
    match /gallery/{category}/{fileName} {
      allow read: if true; // Public galleries
      allow write, delete: if isBoard();
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
