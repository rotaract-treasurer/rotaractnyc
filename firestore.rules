rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return request.auth.token.role;
    }
    
    function isMember() {
      return isAuthenticated() && getUserRole() in ['MEMBER', 'BOARD', 'TREASURER', 'ADMIN'];
    }
    
    function isBoard() {
      return isAuthenticated() && getUserRole() in ['BOARD', 'TREASURER', 'ADMIN'];
    }
    
    function isTreasurer() {
      return isAuthenticated() && getUserRole() in ['TREASURER', 'ADMIN'];
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }
    
    // Users collection
    match /users/{userId} {
      // Members can read users; signed-in users can also read their own profile for approval status.
      allow read: if isMember() || (isAuthenticated() && request.auth.uid == userId);

      // Signed-in users can create their own pending profile (no access to member content until approved).
      allow create: if isAuthenticated()
                    && request.auth.uid == userId
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.role == 'MEMBER'
                    && request.resource.data.status == 'pending';

      // Users can update their own profile (limited fields)
      allow update: if isAuthenticated() && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status']);
      // Only admins can create users or change role/status
      allow delete: if isAdmin();
      allow update: if isAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      // Members can read member-visible events, board can read all
      allow read: if (isMember() && resource.data.visibility == 'member')
                  || (isBoard() && resource.data.visibility in ['member', 'board'])
                  || resource.data.visibility == 'public';
      // Board can create/edit events
      allow create, update, delete: if isBoard();
      
      // RSVPs subcollection
      match /rsvps/{userId} {
        // Members can read all RSVPs for an event
        allow read: if isMember();
        // Members can only write their own RSVP
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Portal Events (separate from public site events)
    match /portalEvents/{eventId} {
      // Members can read member-visible events, board can read all
      allow read: if (isMember() && resource.data.visibility == 'member')
                  || (isBoard() && resource.data.visibility in ['member', 'board'])
                  || resource.data.visibility == 'public';
      // Board can create/edit events
      allow create, update, delete: if isBoard();

      // RSVPs subcollection
      match /rsvps/{userId} {
        // Members can read all RSVPs for an event
        allow read: if isMember();
        // Members can only write their own RSVP
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // Announcements collection
    match /announcements/{announcementId} {
      // Members can read member-visible, board can read all
      allow read: if (isMember() && resource.data.visibility == 'member')
                  || (isBoard() && resource.data.visibility in ['member', 'board']);
      // Board can create/edit announcements
      allow create, update, delete: if isBoard();

      // Acknowledgements subcollection
      match /acknowledgements/{userId} {
        allow read: if isMember();
        allow create, update, delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Community posts (portal dashboard feed)
    match /communityPosts/{postId} {
      allow read: if isMember();
      allow create: if isMember() && request.resource.data.authorUid == request.auth.uid;
      allow update: if isMember() && (
        // Allow any member to update likes array (like/unlike)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
        // Allow author or admin to update other fields
        || resource.data.authorUid == request.auth.uid
        || isAdmin()
      );
      allow delete: if resource.data.authorUid == request.auth.uid || isAdmin();
      
      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isMember();
        allow create: if isMember() && request.resource.data.authorUid == request.auth.uid;
        allow update: if isMember() && (
          // Allow any member to update likes array
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
          // Allow author or admin to update other fields
          || resource.data.authorUid == request.auth.uid
          || isAdmin()
        );
        allow delete: if resource.data.authorUid == request.auth.uid || isAdmin();
      }
    }
    
    // Documents collection
    match /documents/{documentId} {
      // Members can read member-visible, board can read all
      allow read: if (isMember() && resource.data.visibility == 'member')
                  || (isBoard() && resource.data.visibility in ['member', 'board']);
      // Board can create/edit documents
      allow create, update, delete: if isBoard();
    }
    
    // Transactions collection
    match /transactions/{transactionId} {
      // Members can read member-visible, board can read all
      allow read: if (isMember() && resource.data.visibility == 'member')
                  || (isBoard() && resource.data.visibility in ['member', 'board']);
      // Only treasurer/admin can create/edit transactions
      allow create, update, delete: if isTreasurer();
    }
    
    // Monthly summaries collection
    match /monthlySummaries/{monthId} {
      // All members can read monthly summaries
      allow read: if isMember();
      // Only treasurer/admin can write summaries
      allow create, update, delete: if isTreasurer();
    }
    
    // Service hours collection
    match /serviceHours/{submissionId} {
      // Members can read their own submissions, board/admin can read all
      allow read: if (isAuthenticated() && resource.data.uid == request.auth.uid) 
                  || isBoard();
      // Members can create their own submissions
      allow create: if isMember() 
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.status == 'pending';
      // Only board/admin can update (for review/approval)
      allow update: if isBoard();
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
