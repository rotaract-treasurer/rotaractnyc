rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ───────────────────────────────────────
    // Helper functions
    // ───────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    // Look up the member document for the signed-in user.
    // Uses get() which is cached within a single rule evaluation (1 read).
    function memberDoc() {
      return get(/databases/$(database)/documents/members/$(request.auth.uid)).data;
    }

    function hasMemberDoc() {
      return exists(/databases/$(database)/documents/members/$(request.auth.uid));
    }

    // Active member = authenticated + has a member doc with status 'active'
    function isMember() {
      return isAuthenticated() && hasMemberDoc() && memberDoc().status == 'active';
    }

    function memberRole() {
      return memberDoc().role;
    }

    function isBoard() {
      return isMember() && memberRole() in ['board', 'treasurer', 'president'];
    }

    function isTreasurer() {
      return isMember() && memberRole() in ['treasurer', 'president'];
    }

    function isPresident() {
      return isMember() && memberRole() == 'president';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ───────────────────────────────────────
    // Members
    // ───────────────────────────────────────
    match /members/{memberId} {
      // Active members can read the full directory; any signed-in user can read their own doc
      allow read: if isMember() || isOwner(memberId);

      // A signed-in user can create their own pending profile (auto-created on first Google Sign-In)
      allow create: if isOwner(memberId)
                    && request.resource.data.status == 'pending';

      // Members can update their own profile (but not role or status)
      allow update: if isOwner(memberId)
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['role', 'status']);

      // Board+ can update any member (role changes, approval, etc.)
      allow update: if isBoard();

      // Only president can delete members
      allow delete: if isPresident();
    }

    // ───────────────────────────────────────
    // Events (public + portal)
    // ───────────────────────────────────────
    match /events/{eventId} {
      // Public events readable by anyone; portal-only events by active members
      allow read: if resource.data.isPublic == true || isMember();

      // Board+ can manage events
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // RSVPs (top-level, doc ID = "{uid}_{eventId}")
    // ───────────────────────────────────────
    match /rsvps/{rsvpId} {
      // Members can read any RSVP (to see who else is going)
      allow read: if isMember();

      // Members can write their own RSVP (doc ID must start with their uid)
      allow create, update: if isMember()
                            && rsvpId.matches(request.auth.uid + '_.*');

      // Only owner or board can delete
      allow delete: if (isMember() && rsvpId.matches(request.auth.uid + '_.*'))
                    || isBoard();
    }

    // ───────────────────────────────────────
    // Articles (news / blog)
    // ───────────────────────────────────────
    match /articles/{articleId} {
      // Published articles readable by anyone (public site); active members can read all
      allow read: if resource.data.isPublished == true || isMember();

      // Board+ can manage articles
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Gallery
    // ───────────────────────────────────────
    match /gallery/{imageId} {
      // Gallery is publicly readable
      allow read: if true;

      // Board+ can manage gallery
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Community Posts (portal feed)
    // ───────────────────────────────────────
    match /posts/{postId} {
      // Members can read all posts
      allow read: if isMember();

      // Members can create posts (must be authored by them)
      allow create: if isMember()
                    && request.resource.data.authorId == request.auth.uid;

      // Author can update their own post; any member can toggle likes
      allow update: if isMember() && (
        resource.data.authorId == request.auth.uid
        || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
      );

      // Board+ can update/delete any post
      allow update, delete: if isBoard();

      // Author can delete their own post
      allow delete: if isMember() && resource.data.authorId == request.auth.uid;

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isMember();
        allow create: if isMember();
        allow update, delete: if isAuthenticated()
                              && resource.data.authorId == request.auth.uid;
        allow update, delete: if isBoard();
      }
    }

    // ───────────────────────────────────────
    // Documents (meeting minutes, handbooks, etc.)
    // ───────────────────────────────────────
    match /documents/{documentId} {
      // Members can read documents
      allow read: if isMember();

      // Board+ can manage documents
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Service Hours
    // ───────────────────────────────────────
    match /serviceHours/{entryId} {
      // Members can read their own entries; board can read all
      allow read: if (isMember() && resource.data.memberId == request.auth.uid)
                  || isBoard();

      // Members can create their own entries (must be pending)
      allow create: if isMember()
                    && request.resource.data.memberId == request.auth.uid
                    && request.resource.data.status == 'pending';

      // Members can update their own pending entries
      allow update: if isMember()
                    && resource.data.memberId == request.auth.uid
                    && resource.data.status == 'pending';

      // Board+ can approve/reject (update status) and delete
      allow update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Dues Cycles
    // ───────────────────────────────────────
    match /duesCycles/{cycleId} {
      // All members can read dues cycles
      allow read: if isMember();

      // Only treasurer/president can manage cycles
      allow create, update, delete: if isTreasurer();
    }

    // ───────────────────────────────────────
    // Member Dues (per-member dues status)
    // ───────────────────────────────────────
    match /memberDues/{duesId} {
      // Members can read their own dues; treasurer+ can read all
      allow read: if (isMember() && resource.data.memberId == request.auth.uid)
                  || isTreasurer();

      // Treasurer+ can manage dues records
      allow create, update: if isTreasurer();
      allow delete: if isPresident();
    }

    // ───────────────────────────────────────
    // Transactions (finance)
    // ───────────────────────────────────────
    match /transactions/{transactionId} {
      // Only treasurer/president can read & manage transactions
      allow read, create, update, delete: if isTreasurer();
    }

    // ───────────────────────────────────────
    // Messages (member-to-member)
    // ───────────────────────────────────────
    match /messages/{messageId} {
      // Members can read messages sent to them or by them
      allow read: if isMember()
                  && (resource.data.toId == request.auth.uid
                      || resource.data.fromId == request.auth.uid);

      // Members can send messages
      allow create: if isMember()
                    && request.resource.data.fromId == request.auth.uid;

      // Recipient can mark as read
      allow update: if isMember()
                    && resource.data.toId == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      // Sender or recipient can delete their copy
      allow delete: if isMember()
                    && (resource.data.fromId == request.auth.uid
                        || resource.data.toId == request.auth.uid);
    }

    // ───────────────────────────────────────
    // Site Settings (public)
    // ───────────────────────────────────────
    match /settings/{settingId} {
      // Anyone can read site settings (used on public site)
      allow read: if true;

      // Treasurer+ can update settings (payment methods, site config)
      allow write: if isTreasurer();
    }

    // ───────────────────────────────────────
    // Committees
    // ───────────────────────────────────────
    match /committees/{committeeId} {
      // Any active member can read committee info
      allow read: if isMember();

      // All writes go through the admin SDK (server-side API routes);
      // client-side writes are disallowed to enforce capacity + waitlist logic.
      allow write: if false;
    }

    // ───────────────────────────────────────
    // Document Folders
    // ───────────────────────────────────────
    match /documentFolders/{folderId} {
      allow read: if isMember();
      allow create, update, delete: if isBoard();
    }

    // ───────────────────────────────────────
    // Deny everything else
    // ───────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
